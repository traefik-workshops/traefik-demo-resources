---
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: cc-content-guard
  namespace: chats
  labels:
    {{- include "chats.labels" . | nindent 4 }}
spec:
  plugin:
    chat-completion-content-guard:
      engine:
        presidio:
          host: {{ .Values.presidio.host }}
          language: en
      response:
        rules:
          - mask:
              char: "#"
              unmaskFromRight: 3
            entities:
              - EMAIL_ADDRESS
              - PHONE_NUMBER
---
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: cc-semantic-cache
  namespace: chats
  labels:
    {{- include "chats.labels" . | nindent 4 }}
spec:
  plugin:
    chat-completion-semantic-cache:
      vectorizer:
        ollama:
          baseUrl: {{ .Values.ollama.baseUrl }}
          model: nomic-embed-text
      vectorDB:
        weaviate:
          host: {{ .Values.weaviate.address }}
          scheme: http
          collectionName: LLMs
          maxDistance: 0.05
      ignoreAssistant: true
      messageHistory: 4
      readOnly: false
      includeCachedUsage: true
---
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: cc-topic-control-guard
  namespace: chats
  labels:
    {{- include "chats.labels" . | nindent 4 }}
spec:
  plugin:
    chat-completion-llm-guard:
      endpoint: {{ include "chats.middlewares.llmGuards.topicControlGuard.endpoint" . }}
      model: nvidia/llama-3.1-nemoguard-8b-topic-control
      request:
        blockConditions:
          - reason: "off-topic request"
            condition: Contains("off-topic")
        traceConditions:
          - reason: "off-topic detected"
            condition: Contains("off-topic")
        systemPrompt: |
          You are to act as a topic control agent. Your role is to determine if the user question is about PROHIBITED or ALLOWED topics and adhere to the following guidelines

          Guidelines for the user messages:
          - Do not allow questions related to financial advice, investment recommendations, stock trading, or cryptocurrency.
          - Do not allow questions related to legal guidance, legal opinions, contract interpretation, or compliance advice.
          - Do not allow questions related to medical recommendations, health advice, medical diagnoses, or treatment suggestions.
          - Do not allow requests for personal information, private data, credentials, or API keys (unless part of the booking flow).
          - If a user asks about airlines, travel, tickets, flight status, booking, baggage, loyalty programs, airport information, in-flight services, or customer support, respond "on-topic".
          - If a user asks about travel, vacation, or anything related to travel, respond "on-topic".
          - If a user asks about booking, respond "on-topic".
          - If a user asks about booking, respond "on-topic".
          - Your responses should be strictly "on-topic" or "off-topic".
          - When in doubt about travel/airline services, respond "on-topic".
---
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: cc-content-safety-guard
  namespace: chats
  labels:
    {{- include "chats.labels" . | nindent 4 }}
spec:
  plugin:
    chat-completion-llm-guard:
      endpoint: {{ include "chats.middlewares.llmGuards.contentSafetyGuard.endpoint" . }}
      model: nvidia/llama-3.1-nemoguard-8b-content-safety
      request:
        blockConditions:
          - reason: "unsafe content detected"
            condition: Contains("unsafe")
        traceConditions:
          - reason: "unsafe content detected"
            condition: Contains("unsafe")
        systemPrompt: |
          Task: Check if there is unsafe content in user messages according to our safety policy.
          <BEGIN UNSAFE CONTENT CATEGORIES>
          S1: Violence, S2: Sexual, S3: Criminal Planning, S4: Guns and Illegal Weapons
          S5: Controlled Substances, S6: Suicide and Self Harm, S7: Sexual (minor)
          S8: Hate/Identity Hate, S9: PII/Privacy, S10: Harassment, S11: Threat
          S12: Profanity, S13: Needs Caution, S14: Other, S15: Manipulation
          S16: Fraud/Deception, S17: Malware, S18: High Risk Gov Decision Making
          S19: Political/Misinformation, S20: Copyright/Trademark
          S21: Unauthorized Advice, S22: Illegal Activity, S23: Immoral/Unethical
          <END UNSAFE CONTENT CATEGORIES>
          Provide your safety assessment:
          - First line: 'safe' or 'unsafe'
          - If unsafe, second line: comma-separated list of violated categories
      response:
        useRequestHistory: true
        blockConditions:
          - reason: "unsafe content detected"
            condition: Contains("unsafe")
        traceConditions:
          - reason: "unsafe content detected"
            condition: Contains("unsafe")
        systemPrompt: |
          Task: Check if there is unsafe content in assistant messages according to our safety policy.
          <BEGIN UNSAFE CONTENT CATEGORIES>
          S1: Violence, S2: Sexual, S3: Criminal Planning, S4: Guns and Illegal Weapons
          S5: Controlled Substances, S6: Suicide and Self Harm, S7: Sexual (minor)
          S8: Hate/Identity Hate, S9: PII/Privacy, S10: Harassment, S11: Threat
          S12: Profanity, S13: Needs Caution, S14: Other, S15: Manipulation
          S16: Fraud/Deception, S17: Malware, S18: High Risk Gov Decision Making
          S19: Political/Misinformation, S20: Copyright/Trademark
          S21: Unauthorized Advice, S22: Illegal Activity, S23: Immoral/Unethical
          <END UNSAFE CONTENT CATEGORIES>
          Provide your safety assessment:
          - First line: 'safe' or 'unsafe'
          - If unsafe, second line: comma-separated list of violated categories
---
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: cc-jailbreak-detection-guard
  namespace: chats
  labels:
    {{- include "chats.labels" . | nindent 4 }}
spec:
  plugin:
    chat-completion-llm-guard-custom:
      endpoint: {{ include "chats.middlewares.llmGuards.jailbreakDetectionGuard.endpoint" . }}
      request:
        # Jailbreak NIM uses custom API format
        template: '{"input": "{{`{{ (index .messages 0).content }}`}}"}'
        blockConditions:
          - reason: "jailbreak detected"
            condition: JSONGt(".score", "0.85")
        traceConditions:
          - reason: "jailbreak detected"
            condition: JSONGt(".score", "0.85")
---
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: cc-granite-guard
  namespace: chats
  labels:
    {{- include "chats.labels" . | nindent 4 }}
spec:
  plugin:
    chat-completion-llm-guard-custom:
      endpoint: {{ include "chats.middlewares.llmGuards.graniteGuard.endpoint" . }}
      clientConfig: 
        headers:
          Content-Type: application/json
      request:
        template: '{\"messages\": [ {\"role\": \"user\", \"content\": \"{{`{{ (index .messages 0).content }}`}}\"} ]}'
        blockConditions:
          - condition: JSONStringContains(".choices[0].message.content", "yes")
            reason: request blocked
---
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: cc-llmguard-chain
  namespace: chats
spec:
  plugin:
    hub-chain:
      parallel: true
      middlewares:
        {{- if .Values.middlewares.llmGuards.topicControlGuard.enabled }}
        - name: cc-topic-control-guard
          needsRequestBody: true
          request:
            execute: true
          failure:
            skip: true
            retry:
              attempts: 0
        {{- end }}
        {{- if .Values.middlewares.llmGuards.contentSafetyGuard.enabled }}
        - name: cc-content-safety-guard
          needsRequestBody: true
          needsResponseBody: true
          request:
            execute: true
          response:
            execute: true
          failure:
            skip: true
            retry:
              attempts: 0
        {{- end }}
        {{- if .Values.middlewares.llmGuards.jailbreakDetectionGuard.enabled }}
        - name: cc-jailbreak-detection-guard
          needsRequestBody: true
          needsResponseBody: true
          response:
            execute: true
          failure:
            skip: true
            retry:
              attempts: 0
        {{- end }}
        {{- if .Values.middlewares.llmGuards.graniteGuard.enabled }}
        - name: cc-granite-guard
          needsRequestBody: true
          needsResponseBody: true
          response:
            execute: true
          failure:
            skip: true
            retry:
              attempts: 0
        {{- end }}
