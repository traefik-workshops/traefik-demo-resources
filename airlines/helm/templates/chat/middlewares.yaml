---
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: cc-content-guard
  namespace: airlines
  labels:
    {{- include "airlines.labels" . | nindent 4 }}
spec:
  plugin:
    chat-completion-content-guard:
      engine:
        presidio:
          host: {{ .Values.chat.content_guard.presidio.host }}
          language: en
      response:
        rules:
          - mask:
              char: "#"
              unmaskFromRight: 3
            entities:
              - EMAIL_ADDRESS
              - PHONE_NUMBER
---
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: cc-semantic-cache
  namespace: airlines
  labels:
    {{- include "airlines.labels" . | nindent 4 }}
spec:
  plugin:
    chat-completion-semantic-cache:
      vectorizer:
        ollama:
          baseUrl: {{ .Values.chat.semantic_cache.tokenizer.host }}
          model: nomic-embed-text
      vectorDB:
        weaviate:
          host: {{ .Values.chat.semantic_cache.vectorDB.weaviate.host }}
          scheme: http
          collectionName: airlines
          maxDistance: 0.05
      ignoreAssistant: true
      messageHistory: 4
      readOnly: false
      includeCachedUsage: true
---
{{- if .Values.chat.guards.topic_control.enabled }}
---
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: cc-topic-control-guard
  namespace: airlines
  labels:
    {{- include "airlines.labels" . | nindent 4 }}
spec:
  plugin:
    chat-completion-llm-guard:
      endpoint: https://{{ .Values.chat.guards.topic_control.host }}/v1/chat/completions
      model: nvidia/llama-3.1-nemoguard-8b-topic-control
      sendReasonAsError: true
      request:
        promptTemplate: '{"inputs": "{{ `{{ (index .messages (sub (len .messages) 1)).content }}` }}"}'
        blockConditions:
          - reason: "Sorry, I am a ticketing agent and can only answer questions related to Traefik Airlines"
            condition: Contains("off-topic")
        traceConditions:
          - reason: "off-topic detected"
            condition: Contains("off-topic")
        systemPrompt: |
          You are a topic control agent. Determine if the user question is about PROHIBITED or ALLOWED topics.

          CRITICAL: Airlines, Travel, and Ticket queries are ALWAYS ALLOWED. These include ANY questions about:
          - Flight status, schedules, delays, cancellations
          - Booking tickets, modifying reservations, refunds
          - Baggage tracking, policies, fees
          - Loyalty programs, miles, tiers, rewards
          - Airport information, gates, terminals, check-in
          - In-flight services, meals, seats, wifi

          PROHIBITED TOPICS (respond "off-topic"):
          - Financial advice, investment recommendations, stock trading, cryptocurrency
          - Legal guidance, legal opinions, contract interpretation, compliance advice
          - Medical recommendations, health advice, medical diagnoses, treatment suggestions
          - Personal information requests, asking for private data, credentials, API keys (unless part of booking flow)

          AIRLINE SERVICES (all queries, details, and follow-ups):
          - Flight search, availability, pricing, routes
          - Booking management, passenger details, special requests
          - Check-in processes, boarding passes, seat selection
          - Baggage allowance, lost luggage, tracking
          - Loyalty program details, earning/redeeming miles
          - Travel alerts, weather impacts, disruptions
          - Customer support, complaints, compensation
          
          GENERAL QUERIES:
          - Questions asking for "details", "more information", "which", "what", "where" about allowed topics
          - Follow-up questions continuing previous allowed conversations
          - Requests for specific data, locations, names, dates related to allowed services
          - Status inquiries, availability checks, listing requests for allowed topics
          - Any question about data retrievable from airline MCP tools

          EXAMPLES OF ALLOWED QUESTIONS (always respond "on-topic"):
          - "Is flight FL123 on time?"
          - "Book me a ticket to London"
          - "Where is my bag?"
          - "How many miles do I have?"
          - "Can I change my seat?"
          - "What are the baggage fees?"
          - "Show me flights to Paris"
          - "I need to cancel my booking"

          EXAMPLES OF PROHIBITED QUESTIONS (respond "off-topic"):
          - "Should I invest in Bitcoin?" (financial advice)
          - "What medications should I take?" (medical advice)
          - "Can you interpret this legal contract?" (legal advice)

          Analyze the user question and respond ONLY with "on-topic" or "off-topic".
          When in doubt about travel/airline services, respond "off-topic".
{{- end }}
{{- if .Values.chat.guards.content_safety.enabled }}
---
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: cc-content-safety-guard
  namespace: airlines
  labels:
    {{- include "airlines.labels" . | nindent 4 }}
spec:
  plugin:
    chat-completion-llm-guard:
      endpoint: https://{{ .Values.chat.guards.content_safety.host }}/v1/chat/completions
      model: nvidia/llama-3.1-nemoguard-8b-content-safety
      sendReasonAsError: true
      request:
        promptTemplate: '{"inputs": "{{ `{{ (index .messages (sub (len .messages) 1)).content }}` }}"}'
        blockConditions:
          - reason: "unsafe content detected"
            condition: Contains("unsafe")
        traceConditions:
          - reason: "unsafe content detected"
            condition: Contains("unsafe")
        systemPrompt: |
          Task: Check if there is unsafe content in user messages according to our safety policy.
          <BEGIN UNSAFE CONTENT CATEGORIES>
          S1: Violence, S2: Sexual, S3: Criminal Planning, S4: Guns and Illegal Weapons
          S5: Controlled Substances, S6: Suicide and Self Harm, S7: Sexual (minor)
          S8: Hate/Identity Hate, S9: PII/Privacy, S10: Harassment, S11: Threat
          S12: Profanity, S13: Needs Caution, S14: Other, S15: Manipulation
          S16: Fraud/Deception, S17: Malware, S18: High Risk Gov Decision Making
          S19: Political/Misinformation, S20: Copyright/Trademark
          S21: Unauthorized Advice, S22: Illegal Activity, S23: Immoral/Unethical
          <END UNSAFE CONTENT CATEGORIES>
          Provide your safety assessment:
          - First line: 'safe' or 'unsafe'
          - If unsafe, second line: comma-separated list of violated categories
      response:
        promptTemplate: '{"inputs": "{{ `{{ (index .messages (sub (len .messages) 1)).content }}` }}"}'
        useRequestHistory: true
        blockConditions:
          - reason: "unsafe content detected"
            condition: Contains("unsafe")
        traceConditions:
          - reason: "unsafe content detected"
            condition: Contains("unsafe")
        systemPrompt: |
          Task: Check if there is unsafe content in assistant messages according to our safety policy.
          <BEGIN UNSAFE CONTENT CATEGORIES>
          S1: Violence, S2: Sexual, S3: Criminal Planning, S4: Guns and Illegal Weapons
          S5: Controlled Substances, S6: Suicide and Self Harm, S7: Sexual (minor)
          S8: Hate/Identity Hate, S9: PII/Privacy, S10: Harassment, S11: Threat
          S12: Profanity, S13: Needs Caution, S14: Other, S15: Manipulation
          S16: Fraud/Deception, S17: Malware, S18: High Risk Gov Decision Making
          S19: Political/Misinformation, S20: Copyright/Trademark
          S21: Unauthorized Advice, S22: Illegal Activity, S23: Immoral/Unethical
          <END UNSAFE CONTENT CATEGORIES>
          Provide your safety assessment:
          - First line: 'safe' or 'unsafe'
          - If unsafe, second line: comma-separated list of violated categories
{{- end }}
{{- if .Values.chat.guards.jailbreak_detection.enabled }}
---
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: cc-jailbreak-detection-guard
  namespace: airlines
  labels:
    {{- include "airlines.labels" . | nindent 4 }}
spec:
  plugin:
    chat-completion-llm-guard-custom:
      endpoint: https://{{ .Values.chat.guards.jailbreak_detection.host }}/v1/classify
      sendReasonAsError: true
      request:
        # Jailbreak NIM uses custom API format
        template: '{"input": "{{`{{ (index .messages (sub (len .messages) 1)).content }}`}}"}'
        blockConditions:
          - reason: "jailbreak detected"
            condition: JSONGt(".score", "0.85")
        traceConditions:
          - reason: "jailbreak detected"
            condition: JSONGt(".score", "0.85")
{{- end }}
{{- if .Values.chat.guards.granite_guardian.enabled }}
---
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: cc-granite-guard
  namespace: airlines
  labels:
    {{- include "airlines.labels" . | nindent 4 }}
spec:
  plugin:
    chat-completion-llm-guard-custom:
      endpoint: https://{{ .Values.chat.guards.granite_guardian.host }}/v1/chat/completions
      sendReasonAsError: true
      clientConfig: 
        headers:
          Content-Type: application/json
      request:
        template: '{"messages": [{"role": "user", "content": "{{`{{ (index .messages (sub (len .messages) 1)).content }}`}}"}]}'
        blockConditions:
          - condition: JSONStringContains(".choices[0].message.content", "yes")
            reason: request blocked
{{- end }}
{{- if .Values.chat.guards.parallel }}
---
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: cc-llmguard-chain
  namespace: airlines
spec:
  plugin:
    hub-chain:
      parallel: true
      middlewares:
        {{- if .Values.chat.guards.topic_control.enabled }}
        - name: cc-topic-control-guard
          needsRequestBody: true
          request:
            execute: true
          failure:
            skip: true
            retry:
              attempts: 0
        {{- end }}
        {{- if .Values.chat.guards.content_safety.enabled }}
        - name: cc-content-safety-guard
          needsRequestBody: true
          needsResponseBody: true
          request:
            execute: true
          response:
            execute: true
          failure:
            skip: true
            retry:
              attempts: 0
        {{- end }}
        {{- if .Values.chat.guards.jailbreak_detection.enabled }}
        - name: cc-jailbreak-detection-guard
          needsRequestBody: true
          needsResponseBody: true
          response:
            execute: true
          failure:
            skip: true
            retry:
              attempts: 0
        {{- end }}
        {{- if .Values.chat.guards.granite_guardian.enabled }}
        - name: cc-granite-guard
          needsRequestBody: true
          needsResponseBody: true
          response:
            execute: true
          failure:
            skip: true
            retry:
              attempts: 0
        {{- end }}
{{- end }}
