---
# Pricing API - Automated fare calculation
apiVersion: v1
kind: ConfigMap
metadata:
  name: pricing-data
  namespace: airlines
data:
  api.json: |
    {
      "base_fares": {
        "JFK-LAX": {"economy": 400, "premium_economy": 650, "business": 1200, "first": 2500},
        "LAX-JFK": {"economy": 410, "premium_economy": 660, "business": 1250, "first": 2600},
        "SFO-NRT": {"economy": 850, "premium_economy": 1400, "business": 4500, "first": 8500},
        "LHR-JFK": {"economy": 550, "premium_economy": 900, "business": 2800, "first": 6000}
      },
      "taxes_fees": {"domestic": 50, "international": 120}
    }

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: pricing-openapi
  namespace: airlines
data:
  openapi.yaml: |
    openapi: "3.0.0"
    info:
      version: 1.0.0
      title: Pricing API
    servers:
      - url: {{ include "airlines.pricing.apiUrl" . }}
    paths:
      /pricing/{flightId}:
        get:
          summary: Get pricing for a specific flight
          parameters:
            - name: flightId
              in: path
              required: true
              schema:
                type: string
            - name: class
              in: query
              required: true
              schema:
                type: string
            - name: passengers
              in: query
              required: true
              schema:
                type: integer
          responses:
            '200':
              description: Calculated pricing
              content:
                application/json:
                  schema:
                    type: object
                    properties:
                      base_fare: {type: number}
                      taxes: {type: number}
                      total: {type: number}
      /pricing/calculate:
        post:
          summary: Calculate flight pricing
          requestBody:
            content:
              application/json:
                schema:
                  type: object
                  properties:
                    flight_id: {type: string}
                    class: {type: string}
                    passengers: {type: integer}
          responses:
            '200':
              description: Calculated pricing
              content:
                application/json:
                  schema:
                    type: object
                    properties:
                      base_fare: {type: number}
                      taxes: {type: number}
                      total: {type: number}

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: pricing-app
  namespace: airlines
spec:
  replicas: 1
  selector:
    matchLabels:
      app: pricing-app
  template:
    metadata:
      labels:
        app: pricing-app
    spec:
      containers:
        - name: api
          image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
          args: ["-data", "/api/api.json", "-openapi", "/public/openapi.yaml"]
          ports:
            - containerPort: 3000
          volumeMounts:
            - {name: api-data, mountPath: /api}
            - {name: openapi, mountPath: /public}
      volumes:
        - {name: api-data, configMap: {name: pricing-data}}
        - {name: openapi, configMap: {name: pricing-openapi}}

---
apiVersion: v1
kind: Service
metadata:
  name: pricing-app
  namespace: airlines
spec:
  ports:
    - port: 3000
  selector:
    app: pricing-app
