<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Traefik Airlines Ops Board</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        body {
            background-color: #0f172a;
            color: #e2e8f0;
            font-family: 'Inter', sans-serif;
        }

        .card {
            background-color: #1e293b;
            border-radius: 0.5rem;
            padding: 1.5rem;
            border: 1px solid #334155;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(to right, #24A1C1, #60a5fa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-scheduled {
            background-color: #064e3b;
            color: #34d399;
        }

        .status-delayed {
            background-color: #451a03;
            color: #fbbf24;
        }

        .status-cancelled {
            background-color: #450a0a;
            color: #f87171;
        }

        .activity-log {
            max-height: 400px;
            overflow-y: auto;
        }

        .activity-item {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
    </style>
</head>

<body>
    <div id="app" class="min-h-screen p-8">
        <header class="mb-8 flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-white flex items-center gap-4">
                    <img src="https://docs.traefik.io/assets/img/traefik.logo.png" alt="Traefik" class="h-12">
                    <span class="border-l border-slate-600 pl-4">Airlines <span class="text-slate-400 font-light">Ops
                            Center</span></span>
                </h1>
            </div>
            <div class="flex gap-4">
                <div class="text-right">
                    <div class="text-sm text-slate-400">System Status</div>
                    <div class="text-green-400 font-bold">‚óè Operational</div>
                </div>
            </div>
        </header>

        <!-- Stats Grid -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="card">
                <div class="text-slate-400 text-sm uppercase tracking-wider">Active Flights</div>
                <div class="stat-value">{{ stats.flights }}</div>
                <div class="text-sm text-slate-500 mt-2">{{ stats.scheduled }} scheduled, {{ stats.disruptions }}
                    delayed</div>
            </div>
            <div class="card">
                <div class="text-slate-400 text-sm uppercase tracking-wider">Total Bookings</div>
                <div class="stat-value">{{ stats.bookings }}</div>
                <div class="text-sm text-slate-500 mt-2">{{ stats.checkedIn }} checked in</div>
            </div>
            <div class="card">
                <div class="text-slate-400 text-sm uppercase tracking-wider">Passengers</div>
                <div class="stat-value">{{ stats.passengers }}</div>
                <div class="text-sm text-slate-500 mt-2">{{ stats.loyalty }} Loyalty Members</div>
            </div>
            <div class="card">
                <div class="text-slate-400 text-sm uppercase tracking-wider">Check-ins</div>
                <div class="stat-value text-cyan-400">{{ stats.checkedIn }}</div>
                <div class="text-sm text-slate-500 mt-2">Completed Today</div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <!-- Flight Board -->
            <div class="card lg:col-span-2">
                <h2 class="text-xl font-bold mb-4">üõ´ Live Flight Board ({{ flights.length }} flights)</h2>
                <div class="overflow-x-auto max-h-[600px] overflow-y-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="sticky top-0 bg-slate-900">
                            <tr class="text-slate-400 border-b border-slate-700">
                                <th class="pb-3">Flight</th>
                                <th class="pb-3">Route</th>
                                <th class="pb-3">Departure</th>
                                <th class="pb-3">Aircraft</th>
                                <th class="pb-3">Status</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-700">
                            <tr v-for="flight in flights" :key="flight.flight_id"
                                class="hover:bg-slate-800/50 transition">
                                <td class="py-3 font-mono text-blue-400">{{ flight.flight_id }}</td>
                                <td class="py-3">{{ flight.origin }} ‚ûù {{ flight.destination }}</td>
                                <td class="py-3 text-sm">{{ formatDate(flight.departure_time) }}</td>
                                <td class="py-3 text-slate-400">{{ flight.aircraft }}</td>
                                <td class="py-3">
                                    <span :class="['status-badge', 'status-' + flight.status]">
                                        {{ flight.status }}
                                    </span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Recent Bookings -->
            <div class="card">
                <h2 class="text-xl font-bold mb-4">üéüÔ∏è Recent Bookings</h2>
                <div class="space-y-3">
                    <div v-for="booking in recentBookings" :key="booking.booking_id"
                        class="bg-slate-800 p-3 rounded border border-slate-700">
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="font-bold text-white">{{ booking.booking_id }}</div>
                                <div class="text-xs text-slate-400">{{ booking.passenger_id }}</div>
                            </div>
                            <div class="text-right">
                                <div class="text-blue-400 text-sm">{{ booking.flight_id }}</div>
                                <div class="text-xs text-green-400">{{ booking.class }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Flight Delays & Issues -->
        <div class="card">
            <h2 class="text-xl font-bold mb-4">‚ö†Ô∏è Flight Delays & Issues</h2>
            <div class="space-y-2 max-h-96 overflow-y-auto">
                <div v-if="delayedFlights.length === 0" class="text-center py-8 text-slate-500">
                    No delayed or cancelled flights
                </div>
                <div v-for="flight in delayedFlights" :key="flight.flight_id"
                    class="bg-slate-800 p-3 rounded border border-slate-700">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="font-bold text-white font-mono">{{ flight.flight_id }}</div>
                            <div class="text-sm text-slate-400">{{ flight.origin }} ‚Üí {{ flight.destination }}</div>
                        </div>
                        <div class="text-right">
                            <span :class="['status-badge', 'status-' + flight.status]">
                                {{ flight.status }}
                            </span>
                            <div class="text-xs text-slate-400 mt-1">{{ formatDate(flight.departure_time) }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        const { createApp, ref, onMounted, computed } = Vue;

        const DOMAIN = window.location.hostname.replace('dashboard.', '');
        const JWT_TOKEN = window.AIRLINES_CONFIG ? window.AIRLINES_CONFIG.jwtToken : '';

        createApp({
            setup() {
                const flights = ref([]);
                const bookings = ref([]);
                const passengers = ref([]);
                const loyalty = ref([]);
                const checkins = ref([]);

                const stats = computed(() => {
                    const disruptions = flights.value.filter(f => f.status === 'delayed' || f.status === 'cancelled').length;
                    const scheduled = flights.value.filter(f => f.status === 'scheduled').length;
                    const checkedIn = checkins.value.length;

                    return {
                        flights: flights.value.length,
                        bookings: bookings.value.length,
                        passengers: passengers.value.length,
                        loyalty: loyalty.value.length,
                        disruptions,
                        scheduled,
                        checkedIn
                    };
                });

                const recentBookings = computed(() => {
                    return bookings.value.slice(0, 5);
                });

                const delayedFlights = computed(() => {
                    return flights.value.filter(f => f.status === 'delayed' || f.status === 'cancelled');
                });

                const formatDate = (iso) => {
                    if (!iso) return 'N/A';
                    return new Date(iso).toLocaleString('en-US', {
                        month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                    });
                };

                const authHeaders = {
                    'Authorization': `Bearer ${JWT_TOKEN}`
                };

                const fetchData = async () => {
                    try {
                        // Fetch Flights - NOW UNWRAPPED
                        const fRes = await fetch(`https://flights.${DOMAIN}/flights`, { headers: authHeaders });
                        const fData = await fRes.json();
                        flights.value = (Array.isArray(fData) ? fData : []).sort((a, b) =>
                            new Date(a.departure_time) - new Date(b.departure_time)
                        );

                        // Fetch Bookings - NOW UNWRAPPED
                        const bRes = await fetch(`https://bookings.${DOMAIN}/bookings`, { headers: authHeaders });
                        const bData = await bRes.json();
                        bookings.value = (Array.isArray(bData) ? bData : []).reverse();

                        // Fetch Passengers - NOW UNWRAPPED
                        const pRes = await fetch(`https://passengers.${DOMAIN}/passengers`, { headers: authHeaders });
                        const pData = await pRes.json();
                        passengers.value = Array.isArray(pData) ? pData : [];

                        // Fetch Loyalty - NOW UNWRAPPED
                        const lRes = await fetch(`https://loyalty.${DOMAIN}/loyalty`, { headers: authHeaders });
                        const lData = await lRes.json();
                        loyalty.value = Array.isArray(lData) ? lData : [];

                        // Fetch Check-ins - NOW UNWRAPPED
                        const cRes = await fetch(`https://checkin.${DOMAIN}/checkin`, { headers: authHeaders });
                        const cData = await cRes.json();
                        checkins.value = Array.isArray(cData) ? cData : [];

                    } catch (e) {
                        console.error("Error fetching data:", e);
                    }
                };

                onMounted(() => {
                    fetchData();
                    // Auto refresh every 30s
                    setInterval(fetchData, 30000);
                });

                return {
                    flights,
                    stats,
                    recentBookings,
                    delayedFlights,
                    formatDate,
                    refreshData: fetchData
                };
            }
        }).mount('#app');
    </script>
</body>

</html>